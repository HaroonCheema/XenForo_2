<?xml version="1.0" encoding="utf-8"?>
<templates>
  <template type="admin" title="limit_node_selection" version_id="1000300" version_string="1.0.3 Alpha"><![CDATA[<xf:formrow label="{{phrase('forum_selection_limit')}}">
	<div class="check-selection-button">
		<xf:button class="add-limit">{{phrase('add_limit')}}</xf:button>
		<xf:button class="remove-limit">{{phrase('remove_limit')}}</xf:button>
	</div><br>

	<xf:set var="$currentIndex" value="0" />

	<xf:if is="count($options.unique_node_ids)">
		<xf:foreach loop="$options.unique_node_ids" key="$key" value="$nodeId" i="$i">

			<div class="clone-limit-selection" style="display:flex;margin-top: 10px;" data-index="{{$i}}">
				<div class="forum-selection" style="width:80%;">
					<xf:select name="options[unique_node_ids][{{$i}}][]" value="{{$nodeId}}" multiple="multiple" size="4">
						<xf:foreach loop="$nodeTree.getFlattened(0)" value="$treeEntry">
							<xf:option value="{$treeEntry.record.node_id}" disabled="{{ $treeEntry.record.node_type_id != 'Forum' }}">
								{{ repeat('&nbsp;&nbsp;', $treeEntry.depth)|raw }} {$treeEntry.record.title}
							</xf:option>
						</xf:foreach>
					</xf:select>
					<span style="font-size: 13px;color: #8c8c8c;">{{phrase('select_node_against_limit')}}</span>
				</div>
				<div style="width:80%;margin-right:10px;">
					<xf:textbox name="options[node_limits][{{$i}}]" value="{{$options.node_limits.{{$i}} ?: -1 }}" style="margin-left:10px;" />
					<span style="font-size: 13px;color: #8c8c8c;margin-left: 10px;">{{phrase('empty_will_consider_discard')}}</span>
				</div>
			</div>

			<xf:set var="$currentIndex" value="{{$i + 1}}" />
		</xf:foreach>
	</xf:if>

	<div class="limit-selection">
		<div class="clone-limit-selection" style="display:flex;margin-top: 10px;" data-index="{{$currentIndex}}">
			<div class="forum-selection" style="width:80%;">
				<xf:select name="options[unique_node_ids][{{$currentIndex}}][]" multiple="multiple" size="4">
					<xf:option value="0">None</xf:option>
					<xf:foreach loop="$nodeTree.getFlattened(0)" value="$treeEntry">
						<xf:option value="{$treeEntry.record.node_id}" disabled="{{ $treeEntry.record.node_type_id != 'Forum' }}">
							{{ repeat('&nbsp;&nbsp;', $treeEntry.depth)|raw }} {$treeEntry.record.title}
						</xf:option>
					</xf:foreach>
				</xf:select>
				<span style="font-size: 13px;color: #8c8c8c;">{{phrase('select_node_against_limit')}}</span>
			</div>
			<div style="width:80%;margin-right:10px;">
				<xf:textbox name="options[node_limits][{{$currentIndex}}]" style="margin-left:10px;" />
				<span style="font-size: 13px;color: #8c8c8c;margin-left: 10px;">{{phrase('empty_will_consider_discard')}}</span>
			</div>
		</div>
	</div>
</xf:formrow>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
	$(document).ready(function() {
		var index = $('.clone-limit-selection').last().data('index') + 1;

		var initialCheckboxClone = $('.clone-limit-selection').last().clone();

		$('.add-limit').on('click', function() {
			var newClone = initialCheckboxClone.clone();

			newClone.find('select').attr('name', 'options[unique_node_ids][' + index + '][]');
			newClone.find('input').attr('name', 'options[node_limits][' + index + ']');

			newClone.attr('data-index', index);

			$('.limit-selection').append(newClone);

			index++;
		});

		$('.remove-limit').on('click', function() {
			var allCheckboxClones = $('.clone-limit-selection');
			var numberOfClones = allCheckboxClones.length;

			if (numberOfClones > 1) {
				$('.clone-limit-selection').last().remove();
				index--;
			}
		});
	});
</script>]]></template>
</templates>
