<?xml version="1.0" encoding="utf-8"?>
<template_modifications>
  <modification type="public" template="member_macros" modification_key="af_paidregistrations_member_macros_gift" description="Add gift button" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:action_group_2:end]-->]]></find>
    <replace><![CDATA[$0
<xf:if is="property('af_pr_gift_profile') AND $xf.visitor.canGiftUserUpgrade($user)">
	<xf:button class="button--link button--icon" href="{{ link('purchase/gift-upgrade', null, {'userId': $user.user_id}) }}" overlay="true"><i class="fa fa-gift" aria-hidden="true"></i> {{ phrase('af_paidregistrations_gift_upgrade') }}</xf:button>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="message_macros" modification_key="af_paidregistrations_message_macros_gift" description="Add gift button" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[/<xf:userbanners.+?\/>/i]]></find>
    <replace><![CDATA[$0
<xf:if is="property('af_pr_gift_postbit') AND $xf.visitor.canGiftUserUpgrade($user)">
	<xf:button class="button--smaller button--fullWidth button--icon u-hideMedium" href="{{ link('purchase/gift-upgrade', null, {'userId': $user.user_id}) }}" overlay="true"><i class="fa fa-gift" aria-hidden="true"></i> {{ phrase('af_paidregistrations_gift_upgrade') }}</xf:button>
</xf:if>]]></replace>
  </modification>
  <modification type="email" template="payment_received_receipt_user_upgrade" modification_key="af_paidregistrations_receipt_user_upgrade" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<mail:subject>]]></find>
    <replace><![CDATA[<xf:if is="$purchaseRequest.cost_amount AND $purchasable.purchasable.cost_amount">
	<xf:set var="$purchasable.purchasable.cost_amount" value="{$purchaseRequest.cost_amount}" />
</xf:if>
$0]]></replace>
  </modification>
  <modification type="public" template="register_form" modification_key="af_paidregistrations_register_form" description="Add &quot;Account Type&quot; field" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:textboxrow name="username"]]></find>
    <replace><![CDATA[<xf:if is="$xf.options.af_paidregistrations_guest">
    <xf:if is="$userUpgrade">
        <xf:inforow>{{ phrase('af_paidregistrations_fillForm') }}</xf:inforow>
        <xf:formrow label="{{ phrase('af_paidregistrations_accountType') }}">{$userUpgrade.title} ({$userUpgrade.cost_phrase})</xf:formrow>
        <xf:hiddenval name="prk">{$purchaseRequest.request_key}</xf:hiddenval>
    <xf:else />
        <xf:formrow label="{{ phrase('af_paidregistrations_accountType') }}">{$xf.options.af_paidregistrations_freeTitle} ({{ phrase('af_paidregistrations_free') }})</xf:formrow>
    </xf:if>
    <xf:if is="$xf.request.exists('_xfRedirect')">
        {{ redirect_input($xf.request.get('_xfRedirect'), null, false) }}
    </xf:if>
</xf:if>
$0]]></replace>
  </modification>
  <modification type="public" template="register_form" modification_key="af_paidregistrations_register_form_email" description="Modify &quot;Email&quot; field" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[/<xf:macro template="register_macros" name="email_row".+? \/>/si]]></find>
    <replace><![CDATA[<xf:if is="$paidRegistrationsRefreshUrl">
	<xf:head option="paidRegistrationsRefreshUrl">
		<script>
			window.location.href = "{$paidRegistrationsRefreshUrl|escape('js')}";
		</script>
		<noscript>
			<meta http-equiv="refresh" content="0;url={$paidRegistrationsRefreshUrl}" />
		</noscript>
	</xf:head>
</xf:if>

<xf:set var="$emailRowContents">
	$0
</xf:set>
<xf:if is="$purchaseRequest AND $xf.options.af_paidregistrations_force_same_email">
	<xf:set var="$emailRowContents" value="{{ trim($emailRowContents, '') }}" />
	{{ {$emailRowContents|replace('type="email"', 'type="email" readonly="readonly"')|raw} }}
<xf:else />
	{{ $emailRowContents|raw }}
</xf:if>]]></replace>
  </modification>
</template_modifications>
