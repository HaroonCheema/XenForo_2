<?xml version="1.0" encoding="utf-8"?>
<template_modifications>
  <modification type="public" template="PAGE_CONTAINER" modification_key="siropu_referral_system_page_container" description="Add message for referrals." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[{$content|raw}]]></find>
    <replace><![CDATA[<xf:if is="!in_array($template, ['register_form', 'login'])">
	{{ siropu_rs_referral_message() }}
</xf:if>
$0]]></replace>
  </modification>
  <modification type="public" template="account_visitor_menu" modification_key="siropu_referral_system_account_visitor_menu" description="Add referral count." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:stats_pairs:above_points]-->]]></find>
    <replace><![CDATA[$0
<xf:if is="$xf.visitor.hasPermission('siropuReferralSystem', 'refer')">
	<dl class="pairs pairs--justified fauxBlockLink">
		<dt>{{ phrase('siropu_referral_system_referrals') }}</dt>
		<dd>
			<a href="{{ link('members/referrals', $xf.visitor) }}" class="fauxBlockLink-linkRow u-concealed" data-xf-click="overlay">{$xf.visitor.siropu_rs_referral_count|number}</a>
		</dd>
	</dl>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="account_visitor_menu" modification_key="siropu_referral_system_account_visitor_menu_link" description="Add link to visitor menu." execution_order="20" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:content_links:bottom]-->]]></find>
    <replace><![CDATA[$0
<xf:if is="$xf.visitor.hasPermission('siropuReferralSystem', 'refer')">
	<li><a href="{{ link('account/referrals') }}" class="menu-linkRow">{{ phrase('siropu_referral_system_your_referrals') }}</a></li>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="account_wrapper" modification_key="siropu_referral_system_account_wrapper" description="Add account side navigation links." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:profile_links:bottom]-->]]></find>
    <replace><![CDATA[$0
<xf:if is="$xf.visitor.hasPermission('siropuReferralSystem', 'refer')">
     <a class="blockLink {{ $pageSelected == 'referrals' ? 'is-selected' : '' }}" href="{{ link('account/referrals') }}">
          {{ phrase('siropu_referral_system_your_referrals') }}
     </a>
</xf:if>]]></replace>
  </modification>
  <modification type="admin" template="helper_criteria" modification_key="siropu_referral_system_helper_criteria" description="Add the referral user criteria." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:user:content_bottom]-->]]></find>
    <replace><![CDATA[$0
<xf:option name="user_criteria[siropu_rs_referral_count][rule]" value="siropu_rs_referral_count" selected="{$criteria.siropu_rs_referral_count}"
	label="{{ phrase('siropu_referral_system_user_has_at_least_x_referrals:') }}">
	<xf:numberbox name="user_criteria[siropu_rs_referral_count][data][referrals]" value="{$criteria.siropu_rs_referral_count.referrals}"
		size="5" min="0" step="1" />
</xf:option>]]></replace>
  </modification>
  <modification type="admin" template="helper_criteria" modification_key="siropu_referral_system_helper_criteria_is_referral" description="Add the referrer user criteria." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:user:status_top]-->]]></find>
    <replace><![CDATA[$0
<xf:option name="user_criteria[siropu_rs_is_referral][rule]" value="siropu_rs_is_referral" selected="{$criteria.siropu_rs_is_referral}"
					label="{{ phrase('siropu_referral_system_user_has_registered_using_referral_link') }}"/>]]></replace>
  </modification>
  <modification type="public" template="member_list_macros" modification_key="siropu_referral_system_member_list_macros" description="Add referral count." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:stats:end]-->]]></find>
    <replace><![CDATA[$0
<xf:if is="$xf.options.siropuReferralSystemDisplayReferralCount">
	<li><dl class="pairs pairs--inline">
			<dt>{{ phrase('siropu_referral_system_referrals') }}</dt>
		<dd>
			<xf:if is="$user.siropu_rs_referral_count">
				<a href="{{ link('members/referrals', $user) }}" class="fauxBlockLink-linkRow u-concealed" data-xf-click="overlay">{$user.siropu_rs_referral_count|number}</a>
			<xf:else />
				{$user.siropu_rs_referral_count|number}
			</xf:if>
		</dd>
		</dl></li>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="member_macros" modification_key="siropu_referral_system_member_macros" description="Add referral count to the member stats." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:stat_pairs:below_trophies]-->]]></find>
    <replace><![CDATA[<xf:if is="$xf.options.siropuReferralSystemDisplayReferralCount AND $user.siropu_rs_referral_count">
	<dl class="pairs pairs--rows pairs--rows--centered menu-fauxLinkRow">
		<dt>{{ phrase('siropu_referral_system_referrals') }}</dt>
		<dd>
			<a href="{{ link('members/referrals', $user) }}" class="fauxBlockLink-linkRow u-concealed" data-xf-click="overlay">{$user.siropu_rs_referral_count|number}</a>
		</dd>
	</dl>
</xf:if>
<xf:if is="$xf.options.siropuReferralSystemDisplayReferrer AND $user.siropu_rs_referrer_id">
	<dl class="pairs pairs--rows pairs--rows--centered menu-fauxLinkRow">
		<dt>{{ phrase('siropu_referral_system_referrer') }}</dt>
		<dd>
			<xf:username user="$user.SRS_Referrer" class="fauxBlockLink-linkRow u-concealed" rich="true" notooltip="true" />
		</dd>
	</dl>
</xf:if>
$0]]></replace>
  </modification>
  <modification type="public" template="member_view" modification_key="siropu_referral_system_member_view_tab" description="Add referrals tab." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:tabs:after_recent_content]-->]]></find>
    <replace><![CDATA[$0

<xf:if is="$xf.options.siropuReferralSystemMemberProfileReferralTab AND $user.siropu_rs_referral_count">
	<a href="{{ link('members/referrals', $user) }}"
	   class="tabs-tab"
	   id="srsReferrals"
	   role="tab">{{ phrase('siropu_referral_system_referrals') }}</a>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="member_view" modification_key="siropu_referral_system_member_view_tab_panes" description="Add referrals tab pane." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:tab_panes:after_recent_content]-->]]></find>
    <replace><![CDATA[$0

<xf:if is="$xf.options.siropuReferralSystemMemberProfileReferralTab AND $user.siropu_rs_referral_count">
	<li data-href="{{ link('members/referrals', $user) }}" role="tabpanel" aria-labelledby="srsReferrals">
		<div class="blockMessage">{{ phrase('loading...') }}</div>
	</li>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="metadata_macros" modification_key="siropu_referral_system_metadata_macros" description="Transform meta share link into invite link." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<meta property="og:url" content="{$shareUrl}" />]]></find>
    <replace><![CDATA[<meta property="og:url" content="{$shareUrl}{{ siropu_rs_referral_link_param() }}" />]]></replace>
  </modification>
  <modification type="public" template="share_tooltip" modification_key="siropu_referral_contests_share_tooltip" description="Transform share links into referral links." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[{$contentUrl}]]></find>
    <replace><![CDATA[{$contentUrl}{{ siropu_rs_referral_link_param() }}]]></replace>
  </modification>
  <modification type="public" template="spam_cleaner" modification_key="siropu_referral_system_spam_cleaner" description="Add spam cleaner options for referrers and referrals." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[</xf:checkboxrow>]]></find>
    <replace><![CDATA[<xf:if is="$xf.visitor.hasPermission('siropuReferralSystem', 'spamCleaner')">
	<xf:if is="$user.siropu_rs_referrer_id">
		<xf:option name="siropu_referral_system[remove_referrer]" checked="true">
			<xf:label>{{ phrase('siropu_referral_system_remove_referrer') }}</xf:label>
		</xf:option>
	</xf:if>
	<xf:if is="$user.siropu_rs_referral_count">
		<xf:option name="siropu_referral_system[remove_referrals]" checked="true">
			<xf:label>{{ phrase('siropu_referral_system_remove_referrals') }}</xf:label>
		</xf:option>
	</xf:if>
</xf:if>
$0]]></replace>
  </modification>
  <modification type="admin" template="tools_rebuild" modification_key="siropu_referral_system_tools_rebuild" description="Add rebuild cache options." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:rebuild_bottom]-->]]></find>
    <replace><![CDATA[$0
<xf:macro template="tools_rebuild" name="rebuild_job"
		arg-header="Referral System: {{ phrase('siropu_referral_system_rebuild_user_referral_count') }}"
		arg-job="Siropu\ReferralSystem:Referral" />]]></replace>
  </modification>
</template_modifications>
