!function(){"use strict";!function(e,t,o){String.prototype.replaceTagsToValues=String.prototype.replaceTagsToValues||function(e){let t=this;for(const o in e)t=t.replace(new RegExp(`<${o}>`,"g"),e[o]);return t},XF.Messenger=e.extend(XF.Messenger||{},{noticesUrl:"",popupUrl:"",popup:null,enableSound:!1,soundPath:"",$audio:null,init(){e(o).on("xfm:lk",(()=>console.log("dc1953fe3def09d484260b31339265fce6879d3086100101291812eadaf37d67"))),this.noticesUrl=XF.config.messenger.noticesUrl,this.popupUrl=XF.config.messenger.popupUrl,t.getWebsocketsPromise?.().then((({manager:e})=>{e.channels.visitor.listen("XFM.NewMessage",XF.proxy(this,"onNewMessage"))})),XF.config.messenger.popupEnabled&&(this.popup=new XF.ChatPopup({url:this.popupUrl,eventPrefix:"XFM",draggable:!0}),this.isValidPage()&&this.popup.setupFromCookie()),XF.config.messenger.enableSound&&(this.enableSound=!0,this.soundPath=XF.config.messenger.soundPath,this.$audio=e("<audio />").attr("src",this.soundPath).appendTo(o.body))},isValidPage(){return!this.isConversationsPage()&&!this.isAdminPage()},isConversationsPage:()=>!!t.location.href.match(/conversations/)?.length,isAdminPage:()=>!!t.location.href.match(/admin\.php/)?.length,onNewMessage({message:t}){if(t.user_id===XF.config.userId)return;if(!this.isValidPage())return;if(this.popup&&this.popup.isOpened())return;(()=>{if(!this.enableSound)return!1;const e=this.getSoundConfig(),s=e[t.room_tag]||e[parseInt(t.room_tag,10)];return void 0===s||!!s&&!o.hasFocus()})()&&this.playSound(),XF.ajax("GET",this.noticesUrl.replaceTagsToValues({tag:t.room_tag}),{start_message_id:t.id},(({html:t})=>{XF.setupHtmlInsert(t,(t=>{o.hasFocus()?this.showFloatingNotices(t):e(o).one("focus",(()=>{this.showFloatingNotices(t)}))}))}),{global:!1})},showFloatingNotices(o){let s=e(".js-notices.notices--floating");s.length||(s=e('<ul class="notices notices--floating js-notices" data-xf-init="notices" data-type="floating" />').appendTo(e(".u-bottomFixer"))),o.on("click",".js-locationChanger",(o=>{o.preventDefault();const s=e(o.currentTarget);t.location.href=s.data("href")})),o.appendTo(s),XF.activate(o),XF.activate(s),this.setupNoticesDestructTimer(o);const n=XF.Element.getHandler(s,"notices");n.updateNoticeList(),n.filter(),n.start()},setupNoticesDestructTimer(t){t.find(".js-notice").each(((t,o)=>{const s=e(o),n=s.data("display-duration");let i;const a=()=>{s.xfFadeUp(XF.config.speed.slow,(()=>{s.remove()}))};n&&(i=setTimeout(a,n)),s.find(".js-alertToggle").click((()=>{i&&clearTimeout(i),a()}))}))},playSound(){this.$audio[0].play()},getSoundConfig(){return XF.Cookie.getJson(this.getSoundConfigCookieName())||{}},getSoundConfigCookieName:()=>"xfm_chat_sound"}),e((()=>XF.Messenger.init()))}(window.jQuery,window,document)}();
