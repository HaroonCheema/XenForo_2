!function(){"use strict";const t=()=>window.innerWidth<925;!function(o,e,s){XF.ChatPopup=XF.ChatPopup||XF.create({options:{url:"",eventPrefix:"RTC"},loadingPopup:!1,$container:null,$popup:null,state:"closed",__construct(t){this.options=o.extend({},this.options,t),o(s).on("chat:open-popup",((t,o)=>{o||={},o.eventPrefix===this.options.eventPrefix&&this.open(o)})),this.$container=o('<div class="chat-popup-container"></div>'),this.$container.on("chat:new-message",".real-time-chat",XF.proxy(this,"onNewMessage")).on("chat:messages-seen",".real-time-chat",XF.proxy(this,"updateUnreadCountBadge"))},onNewMessage(){this.$popup&&this.getChatTarget().one("chat:room-reloaded",(()=>{this.updateUnreadCountBadge()}))},updateUnreadCountBadge(){if(!this.$popup)return;const t=this.getChatTarget(),o=this.getChat();if(!o)return;const e=t.find(".js-badgePopup"),s=o.rooms.unreadCount;e.text(s),e.toggleClass("is-hidden",s<=0||!this.isCollapsed())},isOpened(){return"open"===this.state},isCollapsed(){return"collapsed"===this.state},async open(t){t=o.extend({query:{},roomTag:""},t);const{query:e,roomTag:s}=t;s?e.tag=s:this.getRoomTagCookie()&&!e.c?.open&&(e.tag=this.getRoomTagCookie()),XF.hideTooltips();const i=()=>{this.updateState("open"),this.$container.trigger("chat-popup:open"),this.$popup.one("chat:initialized",(()=>{const t=this.getChat();t.roomTag&&t.toggleLeftColumn(!1)}))};this.$popup||await this.loadPopup({query:e});const p=this.getChatTarget(),a=this.getChat(),n=()=>{const t=this.getChat();((t,o)=>{o.rooms.creator.$button?.on("slide-menu:toggle",((e,s)=>{t.hasClass("no-left-column")&&o.toggleLeftColumn(!0),s||!o.roomTag||t.hasClass("no-left-column")||o.toggleLeftColumn(!1)}))})(p,t),((t,o)=>{s&&t.toggleClass("no-left-column",o.rooms.open(s)),e.c?.open&&o.rooms.creator.toggleForm(e.c.open)})(p,t),i(this.$popup)};a?n():p.one("chat:init",(()=>{n()})),this.setStateCookie("open"),s&&this.setRoomTagCookie(s)},updatePopupCoords(){const t={top:parseInt(this.$popup.css("top"),10),left:parseInt(this.$popup.css("left"),10)},s=this.$popup.outerHeight(),i=this.$popup.outerWidth(),p=o(e).width()-i,a=o(e).height()-s,n=t;if(this.isCollapsed()){const t=this.getCoordsCookie();t&&(n.left=t.left,n.top=t.top)}const r=Math.max(0,Math.min(n.left,p)),h=Math.max(0,Math.min(n.top,a));t.top!==h&&this.$popup.css("top",h),t.left!==r&&this.$popup.css("left",r)},close(){this.$container.trigger("chat-popup:close"),this.$popup.addClass("is-closing"),setTimeout((()=>{this.$popup.find(".real-time-chat").trigger("chat:unmounted"),this.$popup.remove(),this.$popup=null,this.setStateCookie("closed")}),250)},collapse(t){this.$container.trigger("chat-popup:collapse",[!this.isCollapsed()]);if(o(t.target).closest(".js-closePopup").length)return;const e=this.isCollapsed()?"open":"collapsed";this.updateState(e),this.updateUnreadCountBadge()},updateState(t){const o=this.getChat();o&&(this.state=t,this.$popup.toggleClass("is-collapsed","collapsed"===t),this.setStateCookie(t),"collapsed"===t?(o.ignoreNewMessages=!0,o.visible=!1):(o.ignoreNewMessages=!1,o.visible=!0,o.messages.update((()=>{const t=o.messages.find({unread:!0,visitor:!1}).first();t.length&&(t.addClass("is-highlight"),o.messages.scrollTo(t,"start"),o.messages.setHighlightRemoveTimeout())}))))},onRoomClick(t){const e=o(t.currentTarget).data("room-tag");e&&this.setRoomTagCookie(e)},onResetRoomClick(){this.setRoomTagCookie("")},onDrag(t,o){this.setCoordsCookie(o)},restorePositionFromCookie(){const t=this.getCoordsCookie();t&&this.$popup.css(t)},loadPopup(t){t=Object.assign({query:{},wrapPopupCallback:null,onLoaded:null,global:!0},t);const{query:o,wrapPopupCallback:e,onLoaded:s,global:i}=t;return this.$popup?Promise.resolve():this.loadingPopup?Promise.reject("Already loading"):(this.loadingPopup=!0,new Promise(((t,p)=>{XF.ajax("GET",this.options.url,o,(({html:o})=>{o&&o.content&&XF.setupHtmlInsert(o,((o,i,p)=>{p(!0),this.$popup=o,this.$popup.toggleClass("is-collapsed",this.isCollapsed()),e&&e(this.$popup),this.$popup.on("click",".js-closePopup",XF.proxy(this,"close")),this.$popup.on("click",".js-collapsePopup",XF.proxy(this,"collapse")),this.$popup.on("click",".js-room",XF.proxy(this,"onRoomClick")),this.$popup.on("click",".js-resetRoom",XF.proxy(this,"onResetRoomClick")),this.$popup.on("drag",XF.proxy(this,"onDrag")),this.$popup.appendTo(this.$container),this.restorePositionFromCookie();const a=this.getChatTarget();a.one("chat:initialized",(()=>{const t=this.getChat();this.$popup.trigger("chat:initialized"),a.one("chat:rooms-refreshed",(()=>{this.updateUnreadCountBadge(),t.roomTag&&t.toggleLeftColumn(!1)})),a.one("chat:room-restored",(()=>{t.toggleLeftColumn(!1)})),a.one("chat:default-room-reset",(()=>{t.toggleLeftColumn(!0)}))}));const n=new ResizeObserver((()=>{this.$popup?(this.updatePopupCoords(),this.setSizeCookie({width:this.$popup.outerWidth()})):n.disconnect()}));n.observe(this.$popup[0]),this.$container.appendTo("body"),this.$popup.removeClass("is-loading"),s&&s(this.$popup),XF.activate(this.$popup),this.loadingPopup=!1,t(this.$popup)}))}),{global:i}).catch((()=>{this.loadingPopup=!1,p("Failed to load popup")}))})))},setupFromCookie(){const t=this.getStateCookie(),o=this.getRoomTagCookie();if(!t||"closed"===t)return;const e={};o&&(e.tag=o),this.state=t,this.loadPopup({query:e,global:!1,wrapPopupCallback:t=>{const o=this.getSizeCookie();o&&t.css(o)},onLoaded:o=>{this.updateState(t)}})},setStateCookie(t){XF.Cookie.set(this.getCookieName("state"),t)},getStateCookie(){return XF.Cookie.get(this.getCookieName("state"))},setRoomTagCookie(t){XF.Cookie.set(this.getCookieName("room_tag"),t)},getRoomTagCookie(){return XF.Cookie.get(this.getCookieName("room_tag"))},setCoordsCookie(t){XF.Cookie.setJson(this.getCookieName("coords"),t)},getCoordsCookie(){return XF.Cookie.getJson(this.getCookieName("coords"))},setSizeCookie(t){XF.Cookie.setJson(this.getCookieName("size"),t)},getSizeCookie(){return XF.Cookie.getJson(this.getCookieName("size"))},getCookieName(t){return this.options.eventPrefix.toLowerCase()+"_"+t},getChatTarget(){return this.$popup.find(".real-time-chat")},getChat(){return this.getChatTarget().length?XF.Element.getHandler(this.getChatTarget(),"chat"):null}}),XF.ChatPopupBtn=XF.Element.newHandler({options:{url:"",eventPrefix:"",activeOnMobile:!0},init(){if(!this.options.activeOnMobile&&t())return void this.$target.hide();o('.real-time-chat[data-event-prefix="'+this.options.eventPrefix+'"]').length?this.$target.hide():(this.popup=new XF.ChatPopup({url:this.options.url,eventPrefix:this.options.eventPrefix}),this.popup.setupFromCookie(),this.$target.toggleClass("is-popup-open",null!==this.popup.$popup||this.popup.loadingPopup),this.$target.on("click",XF.proxy(this,"onClick")),this.popup.$container.on("chat-popup:close",(t=>{this.$target.removeClass("is-popup-open")})))},onClick(t){t.preventDefault(),i(this.$target),this.$target.addClass("is-popup-open")}}),XF.RtcDraggable=XF.Element.newHandler({options:{container:"< .js-draggableContainer"},init(){this.$container=this.options.container?XF.findRelativeIf(this.options.container,this.$target):this.$target;const t=()=>{this.$target.draggable({container:this.$container})};void 0===o.fn.draggable?o(s).one("jquery:rtc-plugins-loaded",t):t()}});const i=t=>{const e=t.data("event-prefix"),i=t.data("query")||{};o(s).trigger("chat:open-popup",{eventPrefix:e,query:i,roomTag:t.data("room-tag")})};o(s).on("click",".js-chatPopup",(e=>{!o(e.currentTarget).data("active-on-mobile")&&t()||(e.preventDefault(),i(o(e.currentTarget)))})),XF.Element.register("chat-popup-btn","XF.ChatPopupBtn"),XF.Element.register("rtc-draggable","XF.RtcDraggable")}(jQuery,window,document)}();
