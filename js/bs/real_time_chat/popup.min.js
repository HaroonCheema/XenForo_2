'use strict';!function(){!function(d,r,l){XF.ChatPopup=XF.ChatPopup||XF.create({options:{url:"",eventPrefix:"RTC"},loadingPopup:!1,$container:null,$popup:null,state:"closed",__construct(a){this.options=d.extend({},this.options,a);d(l).on("chat:open-popup",(b,c)=>{c||={};c.eventPrefix===this.options.eventPrefix&&this.open(c)});this.$container=d('<div class="chat-popup-container"></div>');this.$container.on("chat:new-message",".real-time-chat",XF.proxy(this,"onNewMessage")).on("chat:messages-seen",
".real-time-chat",XF.proxy(this,"updateUnreadCountBadge"))},onNewMessage(){this.$popup&&this.getChatTarget().one("chat:room-reloaded",()=>{this.updateUnreadCountBadge()})},updateUnreadCountBadge(){if(this.$popup){var a=this.getChatTarget(),b=this.getChat();b&&(a=a.find(".js-badgePopup"),b=b.rooms.unreadCount,a.text(b),a.toggleClass("is-hidden",0>=b||!this.isCollapsed()))}},isOpened(){return"open"===this.state},isCollapsed(){return"collapsed"===this.state},async open(a){a=d.extend({query:{},roomTag:""},
a);const {query:b,roomTag:c}=a;c?b.tag=c:this.getRoomTagCookie()&&!b.c?.open&&(b.tag=this.getRoomTagCookie());XF.hideTooltips();const e=()=>{this.updateState("open");this.$container.trigger("chat-popup:open");this.$popup.one("chat:initialized",()=>{const g=this.getChat();g.roomTag&&g.toggleLeftColumn(!1)})};this.$popup||await this.loadPopup({query:b});const f=this.getChatTarget(),m=()=>{const g=this.getChat();((h,k)=>{k.rooms.creator.$button?.on("slide-menu:toggle",(v,q)=>{h.hasClass("no-left-column")&&
k.toggleLeftColumn(!0);q||!k.roomTag||h.hasClass("no-left-column")||k.toggleLeftColumn(!1)})})(f,g);c&&f.toggleClass("no-left-column",g.rooms.open(c));b.c?.open&&g.rooms.creator.toggleForm(b.c.open);e(this.$popup)};this.getChat()?m():f.one("chat:init",()=>{m()});this.setStateCookie("open");c&&this.setRoomTagCookie(c)},updatePopupCoords(){var a=parseInt(this.$popup.css("top"),10),b=parseInt(this.$popup.css("left"),10),c=this.$popup.outerHeight(),e=this.$popup.outerWidth();e=d(r).width()-e;c=d(r).height()-
c;if(this.isCollapsed()){const f=this.getCoordsCookie();f&&(b=f.left,a=f.top)}e=Math.max(0,Math.min(b,e));c=Math.max(0,Math.min(a,c));a!==c&&this.$popup.css("top",c);b!==e&&this.$popup.css("left",e)},close(){this.$container.trigger("chat-popup:close");this.$popup.addClass("is-closing");setTimeout(()=>{this.$popup.find(".real-time-chat").trigger("chat:unmounted");this.$popup.remove();this.$popup=null;this.setStateCookie("closed")},250)},collapse(a){this.$container.trigger("chat-popup:collapse",[!this.isCollapsed()]);
d(a.target).closest(".js-closePopup").length||(a=this.isCollapsed()?"open":"collapsed",this.updateState(a),this.updateUnreadCountBadge())},updateState(a){const b=this.getChat();b&&(this.state=a,this.$popup.toggleClass("is-collapsed","collapsed"===a),this.setStateCookie(a),"collapsed"===a?(b.ignoreNewMessages=!0,b.visible=!1):(b.ignoreNewMessages=!1,b.visible=!0,b.messages.update(()=>{const c=b.messages.find({unread:!0,visitor:!1}).first();c.length&&(c.addClass("is-highlight"),b.messages.scrollTo(c,
"start"),b.messages.setHighlightRemoveTimeout())})))},onRoomClick(a){(a=d(a.currentTarget).data("room-tag"))&&this.setRoomTagCookie(a)},onResetRoomClick(){this.setRoomTagCookie("")},onDrag(a,b){this.setCoordsCookie(b)},restorePositionFromCookie(){const a=this.getCoordsCookie();a&&this.$popup.css(a)},loadPopup(a){a=Object.assign({query:{},wrapPopupCallback:null,onLoaded:null,global:!0},a);const {query:b,wrapPopupCallback:c,onLoaded:e,global:f}=a;return this.$popup?Promise.resolve():this.loadingPopup?
Promise.reject("Already loading"):(this.loadingPopup=!0,new Promise((m,g)=>{XF.ajax("GET",this.options.url,b,({html:h})=>{h&&h.content&&XF.setupHtmlInsert(h,(k,v,q)=>{q(!0);this.$popup=k;this.$popup.toggleClass("is-collapsed",this.isCollapsed());c&&c(this.$popup);this.$popup.on("click",".js-closePopup",XF.proxy(this,"close"));this.$popup.on("click",".js-collapsePopup",XF.proxy(this,"collapse"));this.$popup.on("click",".js-room",XF.proxy(this,"onRoomClick"));this.$popup.on("click",".js-resetRoom",
XF.proxy(this,"onResetRoomClick"));this.$popup.on("drag",XF.proxy(this,"onDrag"));this.$popup.appendTo(this.$container);this.restorePositionFromCookie();const n=this.getChatTarget();n.one("chat:initialized",()=>{const p=this.getChat();this.$popup.trigger("chat:initialized");n.one("chat:rooms-refreshed",()=>{this.updateUnreadCountBadge();p.roomTag&&p.toggleLeftColumn(!1)});n.one("chat:room-restored",()=>{p.toggleLeftColumn(!1)});n.one("chat:default-room-reset",()=>{p.toggleLeftColumn(!0)})});const t=
new ResizeObserver(()=>{this.$popup?(this.updatePopupCoords(),this.setSizeCookie({width:this.$popup.outerWidth()})):t.disconnect()});t.observe(this.$popup[0]);this.$container.appendTo("body");this.$popup.removeClass("is-loading");e&&e(this.$popup);XF.activate(this.$popup);this.loadingPopup=!1;m(this.$popup)})},{global:f}).catch(()=>{this.loadingPopup=!1;g("Failed to load popup")})}))},setupFromCookie(){const a=this.getStateCookie(),b=this.getRoomTagCookie();if(a&&"closed"!==a){var c={};b&&(c.tag=
b);this.state=a;this.loadPopup({query:c,global:!1,wrapPopupCallback:e=>{const f=this.getSizeCookie();f&&e.css(f)},onLoaded:e=>{this.updateState(a)}})}},setStateCookie(a){XF.Cookie.set(this.getCookieName("state"),a)},getStateCookie(){return XF.Cookie.get(this.getCookieName("state"))},setRoomTagCookie(a){XF.Cookie.set(this.getCookieName("room_tag"),a)},getRoomTagCookie(){return XF.Cookie.get(this.getCookieName("room_tag"))},setCoordsCookie(a){XF.Cookie.setJson(this.getCookieName("coords"),a)},getCoordsCookie(){return XF.Cookie.getJson(this.getCookieName("coords"))},
setSizeCookie(a){XF.Cookie.setJson(this.getCookieName("size"),a)},getSizeCookie(){return XF.Cookie.getJson(this.getCookieName("size"))},getCookieName(a){return this.options.eventPrefix.toLowerCase()+"_"+a},getChatTarget(){return this.$popup.find(".real-time-chat")},getChat(){return this.getChatTarget().length?XF.Element.getHandler(this.getChatTarget(),"chat"):null}});XF.ChatPopupBtn=XF.Element.newHandler({options:{url:"",eventPrefix:"",activeOnMobile:!0},init(){if(!this.options.activeOnMobile&&925>
window.innerWidth)return void this.$target.hide();d('.real-time-chat[data-event-prefix="'+this.options.eventPrefix+'"]').length?this.$target.hide():(this.popup=new XF.ChatPopup({url:this.options.url,eventPrefix:this.options.eventPrefix}),this.popup.setupFromCookie(),this.$target.toggleClass("is-popup-open",null!==this.popup.$popup||this.popup.loadingPopup),this.$target.on("click",XF.proxy(this,"onClick")),this.popup.$container.on("chat-popup:close",a=>{this.$target.removeClass("is-popup-open")}))},
onClick(a){a.preventDefault();u(this.$target);this.$target.addClass("is-popup-open")}});XF.RtcDraggable=XF.Element.newHandler({options:{container:"< .js-draggableContainer"},init(){this.$container=this.options.container?XF.findRelativeIf(this.options.container,this.$target):this.$target;const a=()=>{this.$target.draggable({container:this.$container})};void 0===d.fn.draggable?d(l).one("jquery:rtc-plugins-loaded",a):a()}});const u=a=>{const b=a.data("event-prefix"),c=a.data("query")||{};d(l).trigger("chat:open-popup",
{eventPrefix:b,query:c,roomTag:a.data("room-tag")})};d(l).on("click",".js-chatPopup",a=>{!d(a.currentTarget).data("active-on-mobile")&&925>window.innerWidth||(a.preventDefault(),u(d(a.currentTarget)))});XF.Element.register("chat-popup-btn","XF.ChatPopupBtn");XF.Element.register("rtc-draggable","XF.RtcDraggable")}(jQuery,window,document)}();