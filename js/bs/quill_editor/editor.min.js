var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(d){return d.raw=d};$jscomp.createTemplateTagFirstArgWithRaw=function(d,f){d.raw=f;return d};$jscomp.arrayIteratorImpl=function(d){var f=0;return function(){return f<d.length?{done:!1,value:d[f++]}:{done:!0}}};$jscomp.arrayIterator=function(d){return{next:$jscomp.arrayIteratorImpl(d)}};
$jscomp.makeIterator=function(d){var f="undefined"!=typeof Symbol&&Symbol.iterator&&d[Symbol.iterator];if(f)return f.call(d);if("number"==typeof d.length)return $jscomp.arrayIterator(d);throw Error(String(d)+" is not an iterable or ArrayLike");};$jscomp.arrayFromIterator=function(d){for(var f,h=[];!(f=d.next()).done;)h.push(f.value);return h};$jscomp.arrayFromIterable=function(d){return d instanceof Array?d:$jscomp.arrayFromIterator($jscomp.makeIterator(d))};
$jscomp.getRestArguments=function(){for(var d=Number(this),f=[],h=d;h<arguments.length;h++)f[h-d]=arguments[h];return f};
!function(d,f,h){function m(a,b,c){var e;return function(){var g=$jscomp.getRestArguments.apply(0,arguments),k=this;clearTimeout(e);e=setTimeout(function(){a.apply(k,g)},b);null==c||c(e)}}var n={background:"background",bold:"bold",code:"code",color:"color",font:"font",italic:"italic",link:"link",script:"script",size:"size",strike:"strike",underline:"underline",align:"align",blockquote:"blockquote","code-block":"code-block",direction:"direction",header:"header",indent:"indent",list:"list",formula:"formula",
image:"image",video:"video"};XF.QuillEditor=XF.Element.newHandler({options:{theme:"bubble",placeholder:"",submitByEnter:!1,active:!0,toolbar:{},formats:[],name:"message",removeNewLineMatcher:!0,draftUrl:"",draftMinInterval:700},lastDraftSave:0,draftAutoSaveTimeoutId:null,saveDrafts:!0,init:function(){var a=this;this.id=this.$target.xfUniqueId();this.$container=this.$target.closest(".js-quillEditorContainer");this.triggerDraftAutoSave=m(XF.proxy(this,"triggerDraftAutoSave"),250,function(c){a.draftAutoSaveTimeoutId=
c});var b={theme:this.options.theme,modules:this.getModules(),formats:this.getAllowedFormats(),placeholder:this.options.placeholder,bounds:this.$target[0]};this.$inputVal=d('<input type="hidden" name="'+this.options.name+'" value="">');this.$target.after(this.$inputVal);this.$target.trigger("xf-quill-editor:options",[b]);this.quill=new Quill(this.$target[0],b);this.removeNewLineMatcher();this.toggle(this.options.active,{force:!0});this.bindReset();this.bindInput();this.bindEnterSubmitter();this.bindResizeEvent();
this.removeQuillLinkFromTooltip();this.$target.parent().on("click",".js-actionSubmit",XF.proxy(this,"actionSubmitClicked")).on("mousedown",".js-actionSubmit",function(c){c.preventDefault();c.stopPropagation()});this.$container.on("click",function(c){d(c.target).is(".js-quillEditorContainer")&&(a.quill.hasFocus()||a.focus())});this.$target.trigger("xf-quill-editor:init",[this.quill])},triggerDraftAutoSave:function(){var a=Date.now();a-this.lastDraftSave<this.options.draftInterval||(this.lastDraftSave=
a,this.saveDraft())},saveDraft:function(){if(this.saveDrafts){var a=this.getHtml(),b=this.getFormData();b.append(this.options.name+"_html",a);XF.ajax("post",this.options.draftUrl,b,null,{skipDefault:!0,skipError:!0,global:!1})}},loadDraft:function(){var a=this;this.options.draftUrl&&XF.ajax("get",this.options.draftUrl,{},function(b){if(b=b.draft)a.setHtml(b.message),a.$target.trigger("xf-quill-editor:draft-loaded",[b])},{global:!1})},removeNewLineMatcher:function(){var a=this;this.options.removeNewLineMatcher&&
this.quill.clipboard.matchers.forEach(function(b,c){if("matchNewline"===b[1].name){var e=a.quill.clipboard.matchers[c][1];a.quill.clipboard.matchers[c][1]=function(g,k){if(g.tagName){var l=g.style.display;g.style.display="inline-block";var p=e.call(this,g,k);g.style.display=l;return p}return e.call(this,g,k)}}})},getModules:function(){var a=this,b=this.getAllowedFormats(),c={toolbar:this.options.toolbar,bbCodeMatchers:!0,imageUploader:{upload:function(e){return new Promise(function(g,k){a.$target.trigger("xf-quill-editor:upload-image",
[e]);var l=new FileReader;l.addEventListener("load",function(){g(l.result)},!1);e?l.readAsDataURL(e):k("No file selected")})}}};b.includes("smilie")&&(c.smilieImg=!0);b.includes("mention")&&(c.mentions=XFQuillMentions,c.mentionsMatcher=!0);return c},getAllowedFormats:function(){var a=[].concat($jscomp.arrayFromIterable(this.options.formats),$jscomp.arrayFromIterable(this.getFormatsFromToolbar()));return[].concat($jscomp.arrayFromIterable(new Set(a)))},getFormatsFromToolbar:function(){for(var a=[],
b=$jscomp.makeIterator(this.options.toolbar),c=b.next();!c.done;c=b.next()){c=$jscomp.makeIterator(c.value);for(var e=c.next();!e.done;e=c.next())(e=n[e.value])&&a.push(e)}return a},removeQuillLinkFromTooltip:function(){"bubble"===this.options.theme&&(this.quill.theme.tooltip.root.querySelector("input[data-link]").dataset.link="https://example.com")},bindReset:function(){var a=this,b=this.$target.closest("form");if(b.length)b.on("reset",function(){a.quill.setText("","silent")})},bindInput:function(){var a=
this;this.quill.on("text-change",function(b,c,e){a.$inputVal.val(a.getHtml());a.options.draftUrl&&"silent"!==e&&a.triggerDraftAutoSave()});this.$inputVal.val(this.getHtml())},bindResizeEvent:function(){var a=this,b=this.$container[0].offsetHeight;(new ResizeObserver(function(c){c=a.$container[0].offsetHeight;b!==c&&(a.$target.trigger("xf-quill-editor:resize",[c,b]),a.updateTooltipMarginTop(),b=c)})).observe(this.$container[0])},updateTooltipMarginTop:function(){"bubble"===this.options.theme&&(this.quill.theme.tooltip.root.style.marginTop=
-1*this.quill.root.scrollTop+"px")},toggle:function(a,b){b=Object.assign({force:!1,hard:!1},b);if(a!==this.options.active||b.force)a?(b.hard&&this.quill.enable(),this.options.active=!0,this.$container.removeClass("is-disabled")):(b.hard&&this.quill.disable(),this.options.active=!1,this.$container.addClass("is-disabled"))},bindEnterSubmitter:function(){var a=this;this.options.submitByEnter&&(XF.Feature.has("touchevents")||this.quill.keyboard.bindings[13].unshift({key:13,shiftKey:!1,handler:function(){if(d(".ql-mention-list-container").length)return!0;
a.actionSubmitClicked()}}))},actionSubmitClicked:function(a){a&&"function"===typeof a.preventDefault&&a.preventDefault();this.options.active&&(this.draftAutoSaveTimeoutId&&(clearTimeout(this.draftAutoSaveTimeoutId),this.draftAutoSaveTimeoutId=null),this.$target.trigger("xf-quill-editor:submit",[this.getHtml(),this.quill]),this.$target.closest("form").submit())},focus:function(a){a=Object.assign({toEnd:!0},a);this.quill.focus();a.toEnd&&this.setSelectionToEnd()},setSelectionToEnd:function(){this.quill.setSelection(this.quill.getLength(),
0)},insertAtCurrentPosition:function(a){if(Array.isArray(a)){var b=$jscomp.makeIterator(a);for(a=b.next();!a.done;a=b.next())this.insertAtCurrentPosition(a.value)}else{b=this.quill.getSelection(!0).index;var c=0;"string"===typeof a&&(this.quill.insertText(b,a),c=a.length);"object"===typeof a&&(c=a.type,a=Object.assign({},a),delete a.type,this.quill.insertEmbed(b,c,a),c=1);this.quill.setSelection(b+c,0)}},getHtml:function(){return this.quill.root.innerHTML},setHtml:function(a){if(0===a.length)return this.quill.setText(""),
this;a instanceof jQuery||(a=d("<div/>").html(a));a.find("script").remove();a.find("style").remove();a=this.quill.clipboard.convert(a[0].outerHTML);this.quill.setContents(a,"silent");return this},getFormData:function(){var a=this.$target[0].closest("form");a||(a=h.createElement("form"),a.innerHTML=this.$container.html());return new FormData(a)}});XF.Element.register("quill-editor","XF.QuillEditor")}(jQuery,window,document);